from ncclient import manager
from lxml import etree
from typing import Any, Dict, List
import os
from .config import settings

def connect(host: str):
    params = {
        'host': host,
        'port': settings.netconf_port,
        'username': settings.netconf_username,
        'device_params': {'name': 'junos'},
        'hostkey_verify': False,
        'allow_agent': False,
        'look_for_keys': False,
        'timeout': 30,
    }
    if settings.netconf_key_path and os.path.exists(settings.netconf_key_path):
        params['key_filename'] = settings.netconf_key_path
    else:
        params['password'] = settings.netconf_password
    return manager.connect(**params)

# Query
def get_interface_configuration(mgr, ifname: str) -> str:
    rpc = etree.Element('get-configuration')
    interfaces = etree.SubElement(rpc, 'interfaces')
    iface = etree.SubElement(interfaces, 'interface')
    etree.SubElement(iface, 'name').text = ifname
    reply = mgr.rpc(rpc)
    return etree.tostring(reply.data, pretty_print=True).decode()

def get_device_interfaces_actual(mgr, interfaces: List[str]) -> Dict[str, Any]:
    out = {}
    for ifn in interfaces:
        cfg = get_interface_configuration(mgr, ifn)
        out[ifn] = {'config': cfg}
    return out

# ELS builders
def build_access_vlan_config(ifname: str, vlan_id: int):
    conf = etree.Element('configuration')
    interfaces = etree.SubElement(conf, 'interfaces')
    iface = etree.SubElement(interfaces, 'interface')
    etree.SubElement(iface, 'name').text = ifname
    unit = etree.SubElement(iface, 'unit'); etree.SubElement(unit, 'name').text = '0'
    family = etree.SubElement(unit, 'family')
    esw = etree.SubElement(family, 'ethernet-switching')
    etree.SubElement(esw, 'interface-mode').text = 'access'
    vlan = etree.SubElement(esw, 'vlan')
    members = etree.SubElement(vlan, 'members'); members.text = str(vlan_id)
    return conf

def build_trunk_config(ifname: str, vlan_members: List[int], native_vlan_id: int | None = None):
    conf = etree.Element('configuration')
    interfaces = etree.SubElement(conf, 'interfaces')
    iface = etree.SubElement(interfaces, 'interface')
    etree.SubElement(iface, 'name').text = ifname
    unit = etree.SubElement(iface, 'unit'); etree.SubElement(unit, 'name').text = '0'
    family = etree.SubElement(unit, 'family')
    esw = etree.SubElement(family, 'ethernet-switching')
    etree.SubElement(esw, 'interface-mode').text = 'trunk'
    vlan = etree.SubElement(esw, 'vlan')
    for vid in vlan_members:
        members = etree.SubElement(vlan, 'members'); members.text = str(vid)
    if native_vlan_id is not None:
        etree.SubElement(esw, 'native-vlan-id').text = str(native_vlan_id)
    return conf

def build_poe_config(ifname: str, enable: bool):
    conf = etree.Element('configuration')
    poe = etree.SubElement(conf, 'poe')
    iface = etree.SubElement(poe, 'interface')
    etree.SubElement(iface, 'name').text = ifname
    disable = etree.SubElement(iface, 'disable')
    if enable:
        disable.set('delete', 'delete')
    return conf

def build_speed_duplex(ifname: str, speed: str | None, auto_negotiation: bool | None, link_mode: str | None):
    conf = etree.Element('configuration')
    interfaces = etree.SubElement(conf, 'interfaces')
    iface = etree.SubElement(interfaces, 'interface')
    etree.SubElement(iface, 'name').text = ifname
    ether = etree.SubElement(iface, 'ether-options')
    if speed and speed != 'auto':
        etree.SubElement(ether, 'speed').text = speed
        if auto_negotiation is not None and not auto_negotiation:
            etree.SubElement(ether, 'no-auto-negotiation')
    else:
        etree.SubElement(ether, 'speed').set('delete', 'delete')
        etree.SubElement(ether, 'no-auto-negotiation').set('delete', 'delete')
    if link_mode:
        etree.SubElement(ether, 'link-mode').text = link_mode
    return conf

# Commit + diff
def edit_and_commit(mgr, conf_xml: etree._Element) -> str:
    mgr.lock('candidate')
    mgr.edit_config(target='candidate', config=conf_xml)
    mgr.validate()
    compare_rpc = etree.Element('get-configuration')
    compare_rpc.set('database', 'candidate')
    compare_rpc.set('compare', 'rollback')
    compare_rpc.set('rollback', '0')
    diff = mgr.rpc(compare_rpc)
    diff_txt = etree.tostring(diff.data, pretty_print=True).decode()
    mgr.commit()
    mgr.unlock('candidate')
    return diff_txt

def rollback_last(mgr):
    rpc = etree.Element('load-configuration')
    etree.SubElement(rpc, 'rollback').text = '1'
    mgr.rpc(rpc)
    mgr.commit()
