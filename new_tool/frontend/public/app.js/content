const API = location.origin.replace(':8080', ':8000');
const deviceSelect=document.getElementById('deviceSelect');const vcContainer=document.getElementById('vcContainer');const syncBtn=document.getElementById('syncBtn');const syncStatus=document.getElementById('syncStatus');const modal=document.getElementById('modal');const modalTitle=document.getElementById('modalTitle');const ifNameInput=document.getElementById('ifName');const accessRow=document.getElementById('accessRow');const trunkRow=document.getElementById('trunkRow');const nativeRow=document.getElementById('nativeRow');const poeEnable=document.getElementById('poeEnable');const speedSel=document.getElementById('speed');const autoNeg=document.getElementById('autoNeg');const linkMode=document.getElementById('linkMode');const userName=document.getElementById('userName');const resultDiv=document.getElementById('result');const applyBtn=document.getElementById('applyBtn');const closeBtn=document.getElementById('closeBtn');function showModal(ifName,isSfp){modal.classList.remove('hidden');modalTitle.textContent=`Configure ${ifName}`;ifNameInput.value=ifName;poeEnable.disabled=isSfp;}function closeModal(){modal.classList.add('hidden');resultDiv.textContent='';}closeBtn.addEventListener('click',closeModal);const modeRadios=Array.from(document.querySelectorAll('input[name="mode"]'));modeRadios.forEach(r=>r.addEventListener('change',()=>{const val=modeRadios.find(x=>x.checked).value;if(val==='access'){accessRow.classList.remove('hidden');trunkRow.classList.add('hidden');nativeRow.classList.add('hidden');}else{accessRow.classList.add('hidden');trunkRow.classList.remove('hidden');nativeRow.classList.remove('hidden');}}));async function loadDevices(){const res=await fetch(`${API}/devices`);const data=await res.json();deviceSelect.innerHTML=data.devices.map(d=>`<option value="${d.name}">${d.name}</option>`).join('');renderVC(data.devices[0]);}async function renderVC(deviceObj){const res=await fetch(`${API}/devices/${deviceObj.name}/interfaces`);const data=await res.json();const vcMembers=deviceObj.vc_members||2;vcContainer.innerHTML='';for(let m=0;m<vcMembers;m++){const card=document.createElement('div');card.className='card';card.innerHTML=`<h2>VC Member ${m}</h2>`;const grid=document.createElement('div');grid.className='grid';for(let i=0;i<48;i++){const name=`ge-${m}/0/${i}`;const port=document.createElement('div');port.className='port rj45';port.textContent=`${i}`;if(data.drift&&data.drift[name]&&data.drift[name].changed){const b=document.createElement('span');b.className='badge';b.textContent='drift';port.appendChild(b);}port.addEventListener('click',()=>showModal(name,false));grid.appendChild(port);}for(let i=0;i<4;i++){const name=`xe-${m}/2/${i}`;const port=document.createElement('div');port.className='port sfp';port.textContent=`SFP ${i}`;if(data.drift&&data.drift[name]&&data.drift[name].changed){const b=document.createElement('span');b.className='badge';b.textContent='drift';port.appendChild(b);}port.addEventListener('click',()=>showModal(name,true));grid.appendChild(port);}card.appendChild(grid);vcContainer.appendChild(card);}}
applyBtn.addEventListener('click',async()=>{const device=deviceSelect.value;const ifn=ifNameInput.value;const mode=modeRadios.find(x=>x.checked).value;const body={user:userName.value||'unknown',changes:{interface:ifn,mode:mode==='access'?{mode:'access',access_vlan:parseInt(document.getElementById('accessVlan').value)}:{mode:'trunk',trunk_vlans:document.getElementById('trunkVlans').value.split(',').map(v=>parseInt(v.trim())).filter(v=>!isNaN(v)),native_vlan_id:parseInt(document.getElementById('nativeVlan').value)||null},poe:{enable:poeEnable.checked},speed_duplex:{speed:speedSel.value,auto_negotiation:autoNeg.checked,link_mode:linkMode.value}}};resultDiv.textContent='Applying...';try{const res=await fetch(`${API}/devices/${device}/interfaces/${encodeURIComponent(ifn)}/configure`,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(body)});const data=await res.json();if(!res.ok)throw new Error(data.detail||'error');resultDiv.textContent=`Success\n\n${data.diff||''}`;}catch(e){resultDiv.textContent=`Error: ${e.message}`;}});
syncBtn.addEventListener('click',async()=>{const device=deviceSelect.value;syncStatus.textContent='Syncing...';try{const res=await fetch(`${API}/devices/${device}/sync`,{method:'POST'});const data=await res.json();syncStatus.textContent=`Synced ${data.count||0} interfaces`;renderVC({name:device,vc_members:2});}catch(e){syncStatus.textContent='Sync failed';}});
deviceSelect.addEventListener('change',async()=>{const name=deviceSelect.value;renderVC({name,vc_members:2});});loadDevices();